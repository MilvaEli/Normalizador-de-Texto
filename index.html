<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>RIDUNaM ¬∑ Normalizador de metadatos</title>
  <link rel="icon" href="favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
  --azul-ridunam: #65aaf8;
  --bg-intensidad: .6;       
  --doodles-opacidad: .18;   
  --doodles-trazo: var(--azul-ridunam);
}

body{
  background:
    radial-gradient(1200px 800px at 10% 0%, rgba(101,170,248, var(--bg-intensidad)) 0%, rgba(101,170,248,0) 60%),
    radial-gradient(1000px 700px at 90% 20%, rgba(180,220,255, var(--bg-intensidad)) 0%, rgba(101,170,248,0) 60%),
    radial-gradient(900px 600px at 40% 100%, rgba(230,242,255, .8) 0%, rgba(101,170,248,0) 70%),
    #f7faff;
}

.bg-doodles{
  position: fixed;
  inset: 0;
  z-index: -1;
  opacity: var(--doodles-opacidad);
  pointer-events: none;
}
  </style>
</head>
<body>
  <svg class="bg-doodles" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <defs>
    <pattern id="pat-libros" width="140" height="140" patternUnits="userSpaceOnUse">
      <rect width="140" height="140" fill="transparent"/>
      <g fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <rect x="18" y="20" width="34" height="22" rx="2"/>
        <path d="M18 26 h34"/>
        <rect x="70" y="16" width="36" height="8" rx="2"/>
        <rect x="72" y="26" width="36" height="8" rx="2"/>
        <rect x="74" y="36" width="36" height="8" rx="2"/>
        <path d="M20 82 q18 -10 36 0 q18 -10 36 0 v20 q-18 -10 -36 0 q-18 -10 -36 0 z"/>
        <path d="M38 76 v26"/>
      </g>
      <g fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"
         transform="translate(80,90) rotate(-18)">
        <rect x="0" y="0" width="32" height="20" rx="2"/>
        <path d="M0 6 h32"/>
        <path d="M36 4 q14 8 28 0 v18 q-14 -8 -28 0 z"/>
        <path d="M50 2 v22"/>
      </g>
    </pattern>
  </defs>

  <rect width="100%" height="100%" fill="url(#pat-libros)" style="color: var(--doodles-trazo);" />
</svg>

  <header>
    <div class="brand-text">
      <h1>Normalizador de metadatos ¬∑ RIDUNaM</h1>
      <p>Repositorio Institucional Digital ¬∑ Universidad Nacional de Misiones</p>
    </div>
    <div class="brand-logo"><img src="ridunam_logo.png" alt="Logo RIDUNaM"></div>
  </header>

<main>
  <section class="panel">
    <label for="entrada">Ac√° pod√©s pegar el texto que quieras ordenar o limpiar: nombres de autoras/es, filiaciones, res√∫menes, t√≠tulos‚Ä¶ lo que necesites dejar prolijo antes de cargarlo al RIDUNaM üíô</label>
    <textarea id="entrada" placeholder="Peg√° aqu√≠ el contenido a procesar..."></textarea>
    <div class="help">El resultado se visualizar√° abajo.</div>
  </section>


    <!-- Botones de acciones (todas operan sobre #entrada ‚Üí #salida) -->
    <section class="actions">
      <button class="primary" onclick="normalizarTexto()">Normalizar texto</button>
      <button class="secondary" onclick="invertirAutores()">Apellido, Nombre</button>
      <button class="secondary" onclick="normalizarFiliacionDesdeEntrada()">Filiaci√≥n</button>
      <button class="secondary" onclick="convertirMinusculas()">a min√∫sculas</button>
      <button class="secondary" onclick="convertirMayusculas()">A MAY√öSCULAS</button>
      <button id="btnCopiar" class="secondary" onclick="copiarSalida()">Copiar</button>
      <button id="btnDescargar" class="secondary" onclick="descargarSalida()">Descargar</button>
    </section>

    <div id="avisos"></div>

    <section class="panel">
     <label for="salida" style="display:flex;align-items:center;gap:.75rem;">
     Resultado
     <span style="font-weight:normal;font-size:.9rem;display:inline-flex;align-items:center;gap:.35rem;">
      <input id="lockResultado" type="checkbox" onchange="toggleLockResultado()" />
      Bloquear edici√≥n
     </span>
     </label>
     <textarea id="salida" placeholder="Ac√° vas a ver el resultado procesado..."></textarea>
    </section>

  </main>

  <div id="toast" class="toast"></div>

  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî util UI ‚Äî‚Äî‚Äî‚Äî‚Äî
    function toast(msg){
      const t=document.getElementById('toast');
      t.textContent=msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }
    function setAviso(html){ document.getElementById('avisos').innerHTML = html || ''; }
    function setSalida(txt){ document.getElementById('salida').value = txt; }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî acciones base (entrada ‚Üí salida) ‚Äî‚Äî‚Äî‚Äî‚Äî
    function normalizarTexto(){
      let texto=document.getElementById('entrada').value;
      texto = texto.replace(/\s+/g,' ').trim();                        // espacios
      texto = texto.replace(/\n{2,}/g,'\n');                           // saltos
      setSalida(texto); setAviso(''); toast('Texto normalizado');
      habilitarCopiarDescargar(true);
    }

    function invertirAutores(){
      let texto=document.getElementById('entrada').value;
      const autores = texto.split(/\n|;/).map(n=>{
        n=n.trim(); if(!n) return '';
        const p=n.split(/\s+/); if(p.length<2) return n;
        const ape=p.pop(), nom=p.join(' ');
        return `${ape}, ${nom}`;
      });
      setSalida(autores.join('\n')); setAviso(''); toast('Autores invertidos');
      habilitarCopiarDescargar(true);
    }
    function toggleLockResultado() {
      const locked = document.getElementById('lockResultado').checked;
      const t = document.getElementById('salida');
      t.readOnly = locked;
    }

    function convertirMinusculas(){
      setSalida(document.getElementById('entrada').value.toLowerCase());
      setAviso(''); toast('a min√∫sculas'); habilitarCopiarDescargar(true);
    }
    function convertirMayusculas(){
      setSalida(document.getElementById('entrada').value.toUpperCase());
      setAviso(''); toast('A MAY√öSCULAS'); habilitarCopiarDescargar(true);
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî Normalizador de Filiaci√≥n SNRD (usa entrada ‚Üí salida) ‚Äî‚Äî‚Äî‚Äî‚Äî
    const PARTICULAS=new Set(['de','da','do','das','dos','del','la','las','los','y']);
    function smartCaseToken(tok,isStart=false){
      const clean=tok.replace(/[.,;:]/g,'');
      if (clean.length>=3 && clean===clean.toUpperCase() && /[A-Z√Å√â√ç√ì√ö√ú√ë]/.test(clean)) return tok.toUpperCase();
      if (!isStart && PARTICULAS.has(clean.toLowerCase())) return tok.toLowerCase();
      return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
    }
    function titleCaseSiglas(s){
      const tk=s.trim().replace(/\s+/g,' ').split(' ');
      return tk.map((t,i)=>smartCaseToken(t,i===0)).join(' ');
    }

function normalizarLineaFiliacion(linea){
  if(!linea || !linea.trim()) return '';

  let txt = linea.trim();
  if(!/^Fil:\s*/i.test(txt)) txt = 'Fil: ' + txt.replace(/^Fil\s*:\s*/i,'');
  txt = txt.replace(/^Fil:\s*/i,'');

  // "Apellido, Nombre"
  const m = txt.match(/^\s*([^.;]+?),\s*([^.;]+?)(?:\.|\s|$)/);
  if(!m) return { error:'Falta ‚ÄúApellido, Nombre‚Äù (con coma).', salida:null };

  const apellido = titleCaseSiglas(m[1]);
  const nombre   = titleCaseSiglas(m[2]);

  // resto = instituciones + "; Pa√≠s"
  let resto = txt.slice(m[0].length).trim();
  const idx = resto.lastIndexOf(';');
  if (idx === -1) return { error:'Falta ‚Äú; Pa√≠s‚Äù.', salida:null };

  const institucionesRaw = resto.slice(0, idx).trim();
  const pais             = resto.slice(idx+1).trim().replace(/\.*$/,'');

  // TODAS las dependencias separadas por punto
  const instituciones = institucionesRaw.split('.').map(s => s.trim()).filter(Boolean);
  if (instituciones.length < 1) {
    return { error:'Debe haber al menos una instituci√≥n antes del ‚Äú; Pa√≠s‚Äù.', salida:null };
  }

  const instOut = instituciones.map(s => titleCaseSiglas(s)).join('. ');
  const outPais = titleCaseSiglas(pais);

  const salida  = `Fil: ${apellido}, ${nombre}. ${instOut}; ${outPais}.`
    .replace(/\s+/g,' ')
    .replace(/\s+\./g,'.')
    .trim();

  // Validaci√≥n: si no matchea, igual devolvemos la salida
  const rx = /^Fil:\s*[^,]+,\s*[^.]+\.\s*[^;]+;\s*[^.]+\.$/;
  if (!rx.test(salida)) {
    return { error:null, salida };
  }

  // ‚Üê ESTE return faltaba
  return { error:null, salida };
} 

    function normalizarFiliacionDesdeEntrada(){
      const src=document.getElementById('entrada').value;
      const lineas=src.split(/\r?\n/);
      const out=[], errs=[];
      lineas.forEach((l,i)=>{
        if(!l.trim()) return;
        const r=normalizarLineaFiliacion(l);
        if(r.error) errs.push(`L√≠nea ${i+1}: ${r.error}`);
        if(r.salida) out.push(r.salida);
      });
      setSalida(out.join('\n'));
      setAviso(errs.length ? ('‚ö†Ô∏è '+errs.join('<br>')) : '‚úÖ Filiaciones v√°lidas');
      toast(errs.length ? 'Revisar avisos' : 'Filiaci√≥n normalizada');

      // Pol√≠tica RIDUNaM: deshabilitar copia/descarga unos segundos para forzar lectura.
      habilitarCopiarDescargar(false);
      setTimeout(()=>habilitarCopiarDescargar(true), 10000); // 10s
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî Copiar / Descargar ‚Äî‚Äî‚Äî‚Äî‚Äî
    async function copiarSalida(){
      const t=document.getElementById('salida').value;
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(t); }
        else{ const el=document.getElementById('salida'); el.select(); document.execCommand('copy'); }
        toast('Resultado copiado');
      }catch(e){ toast('No se pudo copiar'); }
    }
    function descargarSalida(){
      const t=document.getElementById('salida').value;
      const blob=new Blob([t],{type:'text/plain'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download='metadatos_normalizados.txt'; a.click(); toast('Archivo descargado');
    }
    function habilitarCopiarDescargar(enable){
      document.getElementById('btnCopiar').disabled=!enable;
      document.getElementById('btnDescargar').disabled=!enable;
    }

  </script>
</body>
</html>

