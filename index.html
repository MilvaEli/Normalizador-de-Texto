<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RIDUNaM ¬∑ Normalizador de metadatos</title>
  <link rel="icon" href="favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root{
      --azul-ridunam:#aaebf7;
      --azul-ridunam-hover:#8eddea;
      --azul-ridunam-oscuro:#5ec7d7;
      --gris-fondo:#fff5f5;
      --borde-suave:#e2dfdf;
      --texto-principal:#141313;
      --bg-card:#ffffff;
    }

    *{ box-sizing:border-box }

    body{
      font-family:'Open Sans',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
      background:var(--gris-fondo);
      margin:0; padding:0 1rem 4rem;
      color:var(--texto-principal);
      /* patr√≥n suave + watermark */
      background-image:
        repeating-linear-gradient(45deg, rgba(0,0,0,0.04) 0, rgba(0,0,0,0.04) 1px, transparent 1px, transparent 30px),
        repeating-linear-gradient(-45deg, rgba(0,0,0,0.04) 0, rgba(0,0,0,0.04) 1px, transparent 1px, transparent 30px);
      background-size: 60px 60px;
      position: relative;
    }
    body::before{
      content: 'EN PROCESO...  LO ESTAMOS VIENDO...';
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-25deg);
      font-size: 4rem;
      color: rgba(0, 0, 0, 0.05);
      white-space: nowrap;
      z-index: 0;
      user-select: none;
      pointer-events: none;
      font-weight: 400;
    }

    header{
      background:var(--azul-ridunam); color:#0d0d0d; padding:1rem 1.5rem;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:3px solid rgba(0,0,0,.08);
      position: relative; z-index: 1;
    }
    .brand-logo img{height:120px; width:auto; object-fit:contain; display:block}
    .brand-text h1{font-size:1.1rem; font-weight:600; margin:0}
    .brand-text p{font-size:.8rem; margin:0; opacity:.9}

    main{
      max-width:900px; background:var(--bg-card); margin:2rem auto 0; padding:2rem;
      border-radius:16px; box-shadow:0 16px 40px rgba(0,0,0,.07); border:1px solid rgba(0,0,0,.05);
      position: relative; z-index: 1;
    }

    .panel{margin-bottom:1.2rem}
    .panel label{font-size:.9rem; font-weight:600; display:block; margin-bottom:.5rem; color:#333}

    textarea{
      width:100%; min-height:160px; font-size:.95rem; line-height:1.45; padding:1rem; border-radius:8px;
      border:1px solid var(--borde-suave); resize:vertical; font-family:'Open Sans',monospace; background:#fcf9f9; color:#000;
      position: relative; z-index: 1;
    }
    textarea[readonly]{background:#f1f1f1}

    .actions{display:flex; flex-wrap:wrap; gap:.5rem; margin:1rem 0 1rem; position: relative; z-index: 1;}
    button{
      border:none; border-radius:8px; padding:.6rem .9rem; font-size:.9rem; font-weight:600; cursor:pointer;
      line-height:1.2; min-width:130px; box-shadow:0 2px 4px rgba(0,0,0,.08);
      transition:background-color .2s, box-shadow .2s, color .2s, opacity .2s, transform .05s;
    }
    button:active{box-shadow:0 1px 2px rgba(0,0,0,.2); transform:translateY(1px)}
    button.primary{background:var(--azul-ridunam-oscuro); color:#041016}
    button.primary:hover{background:var(--azul-ridunam-hover)}
    button.secondary{background:#ececec; color:#030303}
    button.secondary:hover{background:#050505; color:#fff}
    button[disabled]{opacity:.45; cursor:not-allowed}

    .help{font-size:.9rem; color:#555; margin:.25rem 0 .75rem}
    #avisos{margin-top:.5rem; font-size:.92rem}

    .toast{
      position:fixed; right:1rem; top:1rem; min-width:240px; max-width:320px;
      background:#222; color:#fff; border-radius:8px; padding:.8rem 1rem; font-size:.9rem; line-height:1.4;
      box-shadow:0 12px 32px rgba(0,0,0,.4); opacity:0; visibility:hidden; z-index:9999;
      transition:opacity .3s ease, visibility .3s ease;
    }
    .toast.show{opacity:1; visibility:visible}

    @media (max-width:600px){
      body::before{font-size:3rem;}
      header{flex-direction:column; align-items:flex-start; gap:1rem}
      button{min-width:unset; flex:1 1 calc(50% - .5rem)}
      .actions{gap:.5rem}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand-text">
      <h1>Normalizador de metadatos ¬∑ RIDUNaM</h1>
      <p>Repositorio Institucional Digital ¬∑ Universidad Nacional de Misiones</p>
    </div>
    <div class="brand-logo"><img src="ridunam_logo.png" alt="Logo RIDUNaM" /></div>
  </header>

  <main>
    <section class="panel">
      <label for="entrada">Ac√° pod√©s pegar el texto que quieras ordenar o limpiar: nombres de autoras/es, filiaciones, res√∫menes, t√≠tulos‚Ä¶ lo que necesites dejar prolijo antes de cargarlo al RIDUNaM üíô</label>
      <textarea id="entrada" placeholder="Peg√° aqu√≠ el contenido a procesar..." aria-label="Entrada de texto a normalizar"></textarea>
      <div class="help">Solo habr√° un cuadro de entrada y uno de salida. Eleg√≠ una acci√≥n abajo.</div>
    </section>

    <!-- Botones de acciones -->
    <section class="actions" aria-label="Acciones de normalizaci√≥n">
      <button class="primary" onclick="normalizarTexto()" aria-label="Normalizar texto (eliminar espacios dobles y convertir saltos de l√≠nea en punto aparte)">Normalizar texto</button>
      <button class="secondary" onclick="puntosAparte()" aria-label="Separar por puntos aparte">Puntos aparte</button>
      <button class="secondary" onclick="invertirAutores()" aria-label="Invertir autores a Apellido, Nombre">Apellido, Nombre</button>
      <button class="secondary" onclick="normalizarFiliacionDesdeEntrada()" aria-label="Normalizar filiaci√≥n">Filiaci√≥n</button>
      <button class="secondary" onclick="convertirMinusculas()" aria-label="Convertir a min√∫sculas">a min√∫sculas</button>
      <button class="secondary" onclick="convertirMayusculas()" aria-label="Convertir a may√∫sculas">A MAY√öSCULAS</button>
      <button id="btnCopiar" class="secondary" onclick="copiarSalida()" aria-label="Copiar resultado">üìã Copiar</button>
      <button id="btnDescargar" class="secondary" onclick="descargarSalida()" aria-label="Descargar resultado">‚¨áÔ∏è Descargar</button>
    </section>

    <div id="avisos" role="status" aria-live="polite"></div>

    <section class="panel">
      <label for="salida" style="display:flex;align-items:center;gap:.75rem;">
        Resultado
        <span style="font-weight:normal;font-size:.9rem;display:inline-flex;align-items:center;gap:.35rem;">
          <input id="lockResultado" type="checkbox" onchange="toggleLockResultado()" aria-label="Bloquear edici√≥n del resultado" />
          Bloquear edici√≥n
        </span>
      </label>
      <textarea id="salida" placeholder="Ac√° vas a ver el resultado procesado..." aria-label="Resultado"></textarea>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî util UI ‚Äî‚Äî‚Äî‚Äî‚Äî
    function toast(msg){
      const t=document.getElementById('toast');
      t.textContent=msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 2200);
    }
    function setAviso(html){ document.getElementById('avisos').innerHTML = html || ''; }
    function setSalida(txt){ document.getElementById('salida').value = txt; }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî acciones base (entrada ‚Üí salida) ‚Äî‚Äî‚Äî‚Äî‚Äî
    // Normalizar: elimina espacios dobles y convierte saltos de l√≠nea en punto aparte.
    function normalizarTexto(){
      const src = document.getElementById('entrada').value;

      // Partimos por l√≠neas, limpiamos espacios y quitamos puntos finales para no duplicar
      const lineas = src
        .replace(/\r\n?/g,'\n')
        .split('\n')
        .map(l => l.replace(/\s+/g,' ').trim().replace(/[.]+$/,''))
        .filter(l => l !== '');

      let out = lineas.join('. ');

      // Seguridad extra: colapsar espacios m√∫ltiples
      out = out.replace(/\s{2,}/g,' ').trim();

      // Asegurar un punto final
      if (out && !/[.!?]$/.test(out)) out += '.';

      setSalida(out);
      setAviso('');
      toast('Texto normalizado (saltos de l√≠nea ‚Üí punto aparte)');
      habilitarCopiarDescargar(true);
    }

    // Puntos aparte: a partir de un bloque de texto, separa cada punto aparte en un rengl√≥n.
    function puntosAparte(){
      let txt = document.getElementById('entrada').value;

      // Limpiar espacios m√∫ltiples
      txt = txt.replace(/\s+/g,' ').trim();

      if (!txt){
        setSalida('');
        setAviso('No hay texto para procesar.');
        toast('Sin contenido');
        habilitarCopiarDescargar(false);
        return;
      }

      // Cada punto seguido de espacios pasa a punto + salto de l√≠nea
      const out = txt.replace(/\.\s*/g, ".\n").trim();

      setSalida(out);
      setAviso('');
      toast('Texto separado por puntos aparte');
      habilitarCopiarDescargar(true);
    }

    function invertirAutores(){
      let texto=document.getElementById('entrada').value;
      const autores = texto.split(/\n|;/).map(n=>{
        n=n.trim(); if(!n) return '';
        const p=n.split(/\s+/); if(p.length<2) return n;
        const ape=p.pop(), nom=p.join(' ');
        return `${ape}, ${nom}`;
      });
      setSalida(autores.join('\n')); setAviso(''); toast('Autores invertidos');
      habilitarCopiarDescargar(true);
    }

    function toggleLockResultado() {
      const locked = document.getElementById('lockResultado').checked;
      const t = document.getElementById('salida');
      t.readOnly = locked;
      toast(locked ? 'Resultado bloqueado' : 'Resultado editable');
    }

    function convertirMinusculas(){
      setSalida(document.getElementById('entrada').value.toLowerCase());
      setAviso(''); toast('a min√∫sculas'); habilitarCopiarDescargar(true);
    }
    function convertirMayusculas(){
      setSalida(document.getElementById('entrada').value.toUpperCase());
      setAviso(''); toast('A MAY√öSCULAS'); habilitarCopiarDescargar(true);
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî Normalizador de Filiaci√≥n SNRD (usa entrada ‚Üí salida) ‚Äî‚Äî‚Äî‚Äî‚Äî
    const PARTICULAS=new Set(['de','da','do','das','dos','del','la','las','los','y']);
    function smartCaseToken(tok,isStart=false){
      const clean=tok.replace(/[.,;:]/g,'');
      if (clean.length>=3 && clean===clean.toUpperCase() && /[A-Z√Å√â√ç√ì√ö√ú√ë]/.test(clean)) return tok.toUpperCase();
      if (!isStart && PARTICULAS.has(clean.toLowerCase())) return tok.toLowerCase();
      return tok.charAt(0).toUpperCase()+tok.slice(1).toLowerCase();
    }
    function titleCaseSiglas(s){
      const tk=s.trim().replace(/\s+/g,' ').split(' ');
      return tk.map((t,i)=>smartCaseToken(t,i===0)).join(' ');
    }

    function normalizarLineaFiliacion(linea){
      if(!linea || !linea.trim()) return '';

      // Limpieza m√≠nima y extracci√≥n de "Fil:"
      let txt = linea.trim();
      if(!/^Fil:\s*/i.test(txt)) txt = 'Fil: ' + txt.replace(/^Fil\s*:\s*/i,'');
      txt = txt.replace(/^Fil:\s*/i,'');

      // Captura "Apellido, Nombre"
      const m = txt.match(/^\s*([^.;]+?),\s*([^.;]+?)(?:\.|\s|$)/);
      if(!m) return { error:'Falta ‚ÄúApellido, Nombre‚Äù (con coma).', salida:null };

      const apellido = titleCaseSiglas(m[1]);
      const nombre   = titleCaseSiglas(m[2]);

      // Resto: instituciones (separadas por ".") + "; Pa√≠s"
      let resto = txt.slice(m[0].length).trim();

      // Pa√≠s: despu√©s del √öLTIMO ';'
      const idx = resto.lastIndexOf(';');
      if (idx === -1) return { error:'Falta ‚Äú; Pa√≠s‚Äù.', salida:null };

      let institucionesRaw = resto.slice(0, idx).trim();           // todo antes del ";"
      let pais             = resto.slice(idx+1).trim().replace(/\.*$/,'');

      // Partir en todas las dependencias separadas por punto
      const instituciones = institucionesRaw
          .split('.')
          .map(s => s.trim())
          .filter(Boolean);

      if (instituciones.length < 1) {
        return { error:'Debe haber al menos una instituci√≥n antes del ‚Äú; Pa√≠s‚Äù.', salida:null };
      }

      // Normalizar ‚ÄúTitle Case‚Äù/siglas en CADA dependencia
      const instOut = instituciones.map(s => titleCaseSiglas(s)).join('. ');

      // Ensamblado final:
      const outPais = titleCaseSiglas(pais);
      const salida  = `Fil: ${apellido}, ${nombre}. ${instOut}; ${outPais}.`
        .replace(/\s+/g,' ')
        .replace(/\s+\./g,'.')
        .trim();

      // Validaci√≥n flexible (acepta m√∫ltiples dependencias con puntos)
      const rx = /^Fil:\s*[^,]+,\s*[^.]+\.\s*[^;]+;\s*[^.]+\.$/;
      if (!rx.test(salida)) {
        // avisamos pero devolvemos
        return { error:'Formato fuera de patr√≥n esperado (rev√≠salo).', salida };
      }
      return { error:null, salida };
    }

    function normalizarFiliacionDesdeEntrada(){
      const src=document.getElementById('entrada').value;
      const lineas=src.split(/\r?\n/);
      const out=[], errs=[];
      lineas.forEach((l,i)=>{
        if(!l.trim()) return;
        const r=normalizarLineaFiliacion(l);
        if(r.error) errs.push(`L√≠nea ${i+1}: ${r.error}`);
        if(r.salida) out.push(r.salida);
      });
      setSalida(out.join('\n'));
      setAviso(errs.length ? ('‚ö†Ô∏è '+errs.join('<br>')) : '‚úÖ Filiaciones v√°lidas');
      toast(errs.length ? 'Revisar avisos' : 'Filiaci√≥n normalizada');

      // Pol√≠tica RIDUNaM: deshabilitar copia/descarga unos segundos para forzar lectura.
      habilitarCopiarDescargar(false);
      setTimeout(()=>habilitarCopiarDescargar(true), 10000); // 10s
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî Copiar / Descargar ‚Äî‚Äî‚Äî‚Äî‚Äî
    async function copiarSalida(){
      const t=document.getElementById('salida').value;
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(t); }
        else{ const el=document.getElementById('salida'); el.select(); document.execCommand('copy'); }
        toast('Resultado copiado');
      }catch(e){ toast('No se pudo copiar'); }
    }
    function descargarSalida(){
      const t=document.getElementById('salida').value;
      const blob=new Blob([t],{type:'text/plain'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download='metadatos_normalizados.txt'; a.click(); toast('Archivo descargado');
    }
    function habilitarCopiarDescargar(enable){
      document.getElementById('btnCopiar').disabled=!enable;
      document.getElementById('btnDescargar').disabled=!enable;
    }
  </script>
</body>
</html>
